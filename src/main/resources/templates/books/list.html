<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Books List</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #3498db;
            color: white;
        }
		button[type="submit"]{
		           display: inline-block;
		           padding: 4px 12px;
		           text-decoration: none;
		           color: white;
		           background-color: #3498db;
		           border-radius: 5px;
		       }
		       button[type="submit"]:hover {
		           background-color: #2980b9;
		       }
		/* Styling for the search form */
		       .search-box {
		           margin: 20px;
		       }
		       .search-box input {
		           padding: 10px;
		           font-size: 16px;
		       }
		       .search-box button {
		           padding: 10px 20px;
		           font-size: 16px;
		           background-color: #3498db;
		           color: white;
		           border: none;
		           border-radius: 5px;
		           cursor: pointer;
		       }
		       .search-box button:hover {
		           background-color: #2980b9;
		       }
			   .search-results {
			              margin-top: 10px;
			          }
			          .search-results div {
			              padding: 5px;
			              border-bottom: 1px solid #ccc;
			          }
			  .message {
			             padding: 10px;
			             margin: 10px 0;
			             border-radius: 5px;
			         }
			         .success {
			             color: green;
			             background-color: #e0f5e0;
			         }
			         .error {
			             color: red;
			             background-color: #f5e0e0;
			         }
					 .hidden {
					            display: none;
					        }
    </style>
</head>
<body>
	
	   <script>
	           // Function to handle search input and send AJAX request
	           function searchBooks() {
	               const searchTerm = document.getElementById("searchTerm").value;
	               
	               // Send AJAX request only if searchTerm is not empty
	               if (searchTerm.length >= 0) {
	                   const xhr = new XMLHttpRequest();
	                   xhr.open("POST", "/books/search?searchTerm=" + searchTerm, true);
	                   xhr.onload = function () {
	                       if (xhr.status === 200) {
								const resultsContainer = document.getElementById("searchResults");
								resultsContainer.innerHTML = "";  
	                           resultsContainer.innerHTML = xhr.responseText;
							   
							   document.getElementById("searchTerm").value = searchTerm;

			                   document.getElementById("searchTerm").focus();
	                       }
	                   };
	                   xhr.send();
	               } else {
	                   document.getElementById("searchResults").innerHTML = "";
	               }
	           }
	       </script>

    
	  <div id="searchResults" class="search-results">
		<h1>Books List</h1>
			   <div class="search-box">
			       <form th:action="@{/books/search}" method="post">
			           <input type="text" id="searchTerm" name="searchTerm" placeholder="Enter book title" onkeyup="searchBooks()">
			           <button type="submit">Search</button>
			       </form>
			   </div>
			   
		  <!-- Table to Display Books -->
		      <table>
		          <thead>
		              <tr>
		                  <th>ID</th>
		                  <th>Title</th>
		                  <th>Author</th>
		                  <th>Available</th>
						  <th th:if="${session.user == null || !session.user.adminUser}">Action</th>
		              </tr>
		          </thead>
		          <tbody>
		              <tr th:each="book : ${books}">
		                  <td th:text="${book.id}"></td>
		                  <td th:text="${book.title}"></td>
		                  <td th:text="${book.author}"></td>
		                  <td th:text="${book.available ? 'Yes' : 'No'}"></td>
						  <td th:if="${session.user == null || !session.user.adminUser}"><form th:action="@{/transactions/issue/{id}(id=${book.id})}" method="post">
							<!-- Check if session user is null. If so, set userId to 0 -->
							      <input type="hidden" name="userId" th:value="${session.user != null ? session.user.id : 0}" />
						          <button type="submit">Issue Book</button>
						        </form>
							</td>
		              </tr>
		          </tbody>
		      </table> 
			  <div th:if="${success}" style="color: green;" class="message success" id="successMessage">
			  	          <p th:text="${success}"></p>
			  	      </div>
			  	      <div th:if="${error}" style="color: red;" class="message error" id="errorMessage">
			  	          <p th:text="${error}"></p>
			  	      </div>
	<form class="search-box" th:action="@{/home}" method="get">
	           <button type="submit">Back to Home</button>
	       </form>
	  </div>
	  <script>
	         // Function to hide the message after a set timeout (e.g., 5 seconds)
	         function hideMessage(messageId) {
	             setTimeout(function() {
	                 var messageElement = document.getElementById(messageId);
	                 if (messageElement) {
	                     messageElement.classList.add('hidden');
	                 }
	             }, 5000);  // 5000 milliseconds = 5 seconds
	         }

	         // Auto-hide success and error messages after 5 seconds
	         hideMessage('successMessage');
	         hideMessage('errorMessage');
	     </script>
</body>
</html>